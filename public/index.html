<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pitwall â€” Chat (Neobrutalism)</title>
  <link rel="stylesheet" href="/style.css" />
</head>
<body>
  <header class="nb-header">
    <h1 class="nb-title">Pitwall â€” Cloudflare AI</h1>
    <button id="theme" class="nb-btn nb-btn--ghost" title="Toggle theme">Theme</button>
  </header>

  <main class="nb-container">
    <section class="nb-card nb-card--accent">
      <div class="nb-grid">
        <label class="nb-label" for="session">Session ID</label>
        <div class="nb-inline">
          <input id="session" class="nb-input" placeholder="auto-generatedâ€¦" />
          <button id="new" class="nb-btn">New Session</button>
        </div>
      </div>
      <p class="nb-note">Tip: session keeps short-term memory in a Durable Object. â€œNew Sessionâ€ starts fresh.</p>
    </section>

    <section class="nb-card nb-chat">
      <div id="chat" class="nb-chat__scroll"></div>
    </section>

    <section class="nb-card nb-composer">
      <textarea id="msg" rows="3" class="nb-input nb-input--multiline" placeholder="Type a messageâ€¦"></textarea>
      <div class="nb-actions">
        <button id="mic" class="nb-btn nb-btn--ghost" title="Voice input">ğŸ¤ Speak</button>
        <button id="send" class="nb-btn nb-btn--primary">Send â†’</button>
      </div>
    </section>
  </main>

  <footer class="nb-footer">
    <span>Built with Workers AI + Durable Objects</span>
    <a class="nb-link" href="https://developers.cloudflare.com/workers-ai/" target="_blank" rel="noreferrer">Docs</a>
  </footer>

  <script>
    const session = document.getElementById('session');
    const newBtn  = document.getElementById('new');
    const chat    = document.getElementById('chat');
    const msg     = document.getElementById('msg');
    const send    = document.getElementById('send');
    const mic     = document.getElementById('mic');
    const theme   = document.getElementById('theme');

    // theme toggle
    theme.onclick = () => {
      const next = document.documentElement.dataset.theme === 'dark' ? 'light' : 'dark';
      document.documentElement.dataset.theme = next;
      localStorage.setItem('nb-theme', next);
    };
    document.documentElement.dataset.theme = localStorage.getItem('nb-theme') || 'light';

    // session
    newBtn.onclick = () => {
      session.value = crypto.randomUUID();
      chat.innerHTML = "";
      toast('New session created.');
    };
    if (!session.value) newBtn.click();

    // bubbles
    function addBubble(role, text) {
      const wrap = document.createElement('div');
      wrap.className = 'nb-bubble ' + (role === 'user' ? 'nb-bubble--user' : 'nb-bubble--ai');
      wrap.innerText = text;
      chat.appendChild(wrap);
      chat.scrollTop = chat.scrollHeight;
    }

    // tiny toast
    function toast(t) {
      const el = document.createElement('div');
      el.className = 'nb-toast';
      el.textContent = t;
      document.body.appendChild(el);
      setTimeout(() => el.classList.add('is-in'), 10);
      setTimeout(() => el.classList.remove('is-in'), 2200);
      setTimeout(() => el.remove(), 2600);
    }

    // send
    send.onclick = async () => {
      const s = session.value.trim();
      const m = msg.value.trim();
      if (!s || !m) return toast('Type a message first.');
      addBubble('user', m);
      msg.value = '';
      send.disabled = true;

      try {
        const r = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'content-type': 'application/json' },
          body: JSON.stringify({ sessionId: s, message: m })
        });
        const data = await r.json();
        addBubble('ai', data.reply ?? '[no reply]');
      } catch (e) {
        addBubble('ai', 'âš ï¸ Error contacting server.');
      } finally {
        send.disabled = false;
      }
    };

    // voice
    let rec;
    mic.onclick = () => {
      if (!('webkitSpeechRecognition' in window)) {
        return toast('SpeechRecognition not supported.');
      }
      if (!rec) {
        const R = window.webkitSpeechRecognition;
        rec = new R();
        rec.lang = 'en-US';
        rec.interimResults = false;
        rec.onresult = e => {
          const text = Array.from(e.results).map(r => r[0].transcript).join(' ');
          msg.value = (msg.value ? (msg.value + ' ') : '') + text;
        };
      }
      rec.start();
      toast('Listeningâ€¦');
    };

    // submit on Ctrl/âŒ˜+Enter
    msg.addEventListener('keydown', (e) => {
      if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') send.click();
    });
  </script>
</body>
</html>
